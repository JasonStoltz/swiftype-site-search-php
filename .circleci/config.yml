version: 2.1

defaults:
  working_directory: /tmp/build
  environment:
    ST_ENGINE_NAME: php-integration-test-$CIRCLE_BUILD_NUM

php_71: &php_71
  docker:
  - image: circleci/php:7.1-browsers

php_56: &php_56
  docker:
  - image: circleci/php:5.6-browsers

commands:
  install_deps:
    steps:
    - checkout
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "composer.json" }}
    - run:
        name: Install composer dependencies
        command: composer install -n --prefer-dist
    - save_cache:
        paths:
        - ~/.composer/cache/
        key: v1-dependencies-{{ checksum "composer.json" }}
    - persist_to_workspace:
        root: .
        paths:
          - .

jobs:
  build_php_71:
    <<: *php_71
    steps:
    - install_deps

  build_php_56:
    <<: *php_56
    steps:
    - install_deps

workflows:
  version: 2
  build_and_test_php_56:
    jobs:
    - build_php_56
  build_and_test_php_71:
    jobs:
    - build_php_71

# version: 2.1
#
# defaults:
#   environment:
#     ST_ENGINE_NAME: php-integration-test-$CIRCLE_BUILD_NUM
#
# php_71: &php_71
#   working_directory: /tmp/build/7.1
#   docker:
#   - image: circleci/php:7.1-browsers
#
# php_56: &php_56
#   working_directory: /tmp/build/5.6
#   docker:
#   - image: circleci/php:5.6-browsers
#
# commands:
#   install_deps:
#     steps:
#       - checkout
#       - restore_cache:
#           keys:
#           - v1-dependencies-{{ checksum "composer.json" }}
#       - attach_workspace:
#           at: /tmp/build
#       - run:
#           name: Install composer dependencies
#           command: composer install -n --prefer-dist
#       - persist_to_workspace:
#           root: /tmp/build
#           paths:
#           - .
#       - save_cache:
#           paths:
#           - ~/.composer/cache/
#           key: v1-dependencies-{{ checksum "composer.json" }}
#       - run:
#           command: ls /tmp/build
#   phpunit:
#     parameters:
#       test_suite:
#         type: string
#     steps:
#       - attach_workspace:
#           at: /tmp/build
#       - run:
#           command: vendor/bin/phpunit -c phpunit.xml.dist --testsuite << parameters.test_suite >>
#
# jobs:
#   build_php_71:
#     <<: *php_71
#     steps:
#     - install_deps
#
#   build_php_56:
#     <<: *php_56
#     steps:
#     - install_deps
#
#   test_php_71:
#     <<: *php_71
#     steps:
#     - phpunit:
#         test_suite: unit
#
#   test_php_56:
#     <<: *php_56
#     steps:
#     - phpunit:
#         test_suite: unit
#
#   qa_phpcs:
#     <<: *php_71
#     steps:
#     - attach_workspace:
#         at: /tmp/build
#     - run:
#         name: PHPCS
#         command: vendor/bin/phpcs --ignore=vendor,resources --standard=PSR12 .
#
# workflows:
#   version: 2
#   build_and_test:
#     jobs:
#     - build_php_71
#     - test_php_71:
#         requires:
#         - build_php_71
#     - qa_phpcs:
#         requires:
#         - build_php_71
#     - build_php_56
#     - test_php_56:
#         requires:
#         - build_php_56
#
#
# version: 2.1
#
# php_71: &php_71
#   working_directory: /tmp/build/7.1
#   docker:
#   - image: circleci/php:7.1-browsers
#   environment:
#     PHP_VERSION: "7.1"
#
# php_56: &php_56
#   working_directory: /tmp/build/5.6
#   docker:
#   - image: circleci/php:5.6-browsers
#   environment:
#     PHP_VERSION: "5.6"
#
# commands:
#   install_deps:
#     steps:
#       - checkout
#       - restore_cache:
#           keys:
#           - v1-dependencies-{{ checksum "composer.json" }}
#       - attach_workspace:
#           at: /tmp/build
#       - run:
#           name: Install composer dependencies
#           command: composer install -n --prefer-dist
#       - persist_to_workspace:
#           root: /tmp/build
#           paths:
#           - .
#       - save_cache:
#           paths:
#           - ~/.composer/cache/
#           key: v1-dependencies-{{ checksum "composer.json" }}
#       - run:
#           command: ls /tmp/build
#   phpunit:
#     parameters:
#       test_suite:
#         type: string
#     steps:
#       - attach_workspace:
#           at: /tmp/build
#       - run:
#           command: vendor/bin/phpunit -c phpunit.xml.dist --testsuite << parameters.test_suite >>
#
# jobs:
#   build_php_71:
#     <<: *php_71
#     steps:
#     - install_deps
#
#   test_unit_php_71:
#     <<: *php_71
#     steps:
#     - phpunit:
#         test_suite: unit
#
#   qa_phpcs:
#     <<: *php_71
#     steps:
#     - attach_workspace:
#         at: /tmp/build
#     - run:
#         name: PHPCS
#         command: vendor/bin/phpcs --ignore=vendor,resources --standard=PSR12 .
#
#   build_php_56:
#     <<: *php_56
#     steps:
#     - install_deps
#
#   test_unit_php_56:
#     <<: *php_56
#     steps:
#     - phpunit:
#         test_suite: unit
#
# #
# workflows:
#   version: 2
#   build_and_test:
#     jobs:
#     - build_php_71
#     - test_unit_php_71:
#         requires:
#         - build_php_71
#     - qa_phpcs:
#         requires:
#         - build_php_71
#     - build_php_56
#     - test_unit_php_71:
#         requires:
#         - build_php_56
#
#
# version: 2
#
# defaults: &defaults
#   docker:
#   - image: circleci/php:7.1-browsers
#   working_directory: ~/repo
#
# jobs:
#   build:
#     <<: *defaults
#     steps:
#     - checkout
#     - restore_cache:
#         keys:
#         - v1-dependencies-{{ checksum "composer.json" }}
#         - v1-dependencies-
#     - run:
#         name: Install composer dependencies
#         command: composer install -n --prefer-dist
#     - persist_to_workspace:
#         root: .
#         paths:
#         - .
#     - save_cache:
#         paths:
#         - ~/.composer/cache/
#         key: v1-dependencies-{{ checksum "composer.json" }}
#
#   test_unit:
#     <<: *defaults
#     steps:
#     - attach_workspace:
#         at: .
#     - run:
#         name: Unit testing
#         command: vendor/bin/phpunit -c phpunit.xml.dist --testsuite unit
#
#   test_integration:
#     <<: *defaults
#     steps:
#     - attach_workspace:
#         at: .
#     - run:
#         name: Integration testing
#         command: ST_ENGINE_NAME="php-integration-test-$CIRCLE_BUILD_NUM" vendor/bin/phpunit -c phpunit.xml.dist --testsuite integration``
#
#   test_phpcs:
#     <<: *defaults
#     steps:
#     - attach_workspace:
#         at: .
#     - run:
#         name: PHPCS
#         command: vendor/bin/phpcs --ignore=vendor,resources --standard=PSR12 .
#
# workflows:
#   version: 2
#   build_and_test:
#     jobs:
#     - build
#     - test_unit:
#         requires:
#         - build
#     - test_integration:
#         requires:
#         - build
#     - test_phpcs:
#         requires:
#         - build
